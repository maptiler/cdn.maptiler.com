(function(a,l){typeof exports=="object"&&typeof module<"u"?l(exports):typeof define=="function"&&define.amd?define(["exports"],l):(a=typeof globalThis<"u"?globalThis:a||self,l(a.maptilermarkerlayout={}))})(this,function(a){"use strict";var A=Object.defineProperty;var N=(a,l,h)=>l in a?A(a,l,{enumerable:!0,configurable:!0,writable:!0,value:h}):a[l]=h;var o=(a,l,h)=>N(a,typeof l!="symbol"?l+"":l,h);const y={name:"@maptiler/marker-layout",version:"2.0.0-rc.2",description:"Maker layout manager for MapTiler SDK, frontend framework agnostic",module:"dist/maptiler-marker-layout.mjs",types:"dist/maptiler-marker-layout.d.ts",type:"module",exports:{".":{import:"./dist/maptiler-marker-layout.mjs",types:"./dist/maptiler-marker-layout.d.ts"}},author:"MapTiler Team",homepage:"https://docs.maptiler.com",repository:{type:"git",url:"https://github.com/maptiler/maptiler-marker-layout.git"},keywords:["maptiler","plugin","data"],scripts:{format:'prettier -c "src/**/*.{js,ts,tsx}"',lint:'eslint "src/**/*.{js,ts}"',"format:fix":'prettier --write "src/**/*.{js,ts,tsx}"',"lint:fix":'eslint --fix "src/**/*.{js,ts}"',make:"npm run format:fix && npm run lint:fix && npm run build",dev:"vite -c vite.config-es.ts",build:"npm run build-es; npm run build-umd","build-dev":"NODE_ENV=development npm run build-es; NODE_ENV=development npm run build-umd","build-umd":"tsc && vite build -c vite.config-umd.ts","build-es":"tsc && vite build -c vite.config-es.ts","build-umd-dev-watch":"tsc && NODE_ENV=development vite build -w -c vite.config-umd.ts"},license:"",devDependencies:{"@types/node":"^20.14.2","@typescript-eslint/eslint-plugin":"^7.12.0","@typescript-eslint/parser":"^7.12.0",eslint:"^8.57.0","eslint-import-resolver-typescript":"^3.6.1","eslint-plugin-import":"^2.29.1",prettier:"^3.3.1",typescript:"^5.4.5",vite:"^5.2.12","vite-plugin-dts":"^3.9.1"},dependencies:{"@maptiler/sdk":"^3.0.0-rc.5"}};function v(n){const e=n.map(u=>u.id);e.sort();const t=e.join("_");let i=0;for(let u=0;u<t.length;u++){const d=t.charCodeAt(u);i=(i<<5)-i+d,i|=0}return i}function P(n){if(n.geometry.type!=="Point")return"";const e=new Float32Array(n.geometry.coordinates.slice(0,2));return new Uint8Array(e.buffer).join("_")}function x(n,e){return!(e.position[0]>n.position[0]+n.size[0]||e.position[0]+e.size[0]<n.position[0]||e.position[1]>n.position[1]+n.size[1]||e.position[1]+e.size[1]<n.position[1])}function w(n,e){const t=e.values();for(const i of t)if(x(n,i))return!0;return!1}class z{constructor(e,t={}){o(this,"layers");o(this,"markerSize");o(this,"markerAnchor");o(this,"map");o(this,"lastStatus");o(this,"max");o(this,"offset",[0,0]);o(this,"lastPresent");o(this,"filter",null);o(this,"groupBy",null);o(this,"maxRatioUnitSize");o(this,"sortingProperty","");o(this,"sortingOrder",1);o(this,"maxNbFeaturesPerMarker",Number.POSITIVE_INFINITY);if(e.telemetry.registerModule(y.name,y.version),this.map=e,this.layers=t.layers??void 0,this.markerAnchor=t.markerAnchor??"center",this.markerSize=t.markerSize??[150,50],this.max=t.max??null,this.lastStatus={new:new Map,updated:new Map,removed:new Map},this.lastPresent=new Map,this.filter=t.filter??null,this.offset=t.offset??[0,0],this.groupBy=t.groupBy??null,this.maxRatioUnitSize=t.maxRatioUnitSize??2.5,this.sortingProperty=t.sortingProperty??"",this.maxNbFeaturesPerMarker=t.maxNbFeaturesPerMarker??Number.POSITIVE_INFINITY,t.sortingOrder&&!["ascending","descending"].includes(t.sortingOrder))throw new Error("The property `options.sortingOrder` must be 'ascending' or 'descending' if provided.");this.sortingOrder=t.sortingOrder==="descending"?-1:1}computeAnchorOffset(e=1){let t=[0,0];return this.markerAnchor==="center"?t=[-this.markerSize[0]/2,e*-this.markerSize[1]/2]:this.markerAnchor==="top"?t=[-this.markerSize[0]/2,e*-this.markerSize[1]]:this.markerAnchor==="bottom"?t=[-this.markerSize[0]/2,0]:this.markerAnchor==="left"?t=[-this.markerSize[0],e*-this.markerSize[1]/2]:this.markerAnchor==="right"&&(t=[0,-this.markerSize[1]]),t[0]+=this.offset[0],t[1]+=this.offset[1],t}softUpdateAbstractMarker(e){const t=e.features[0].geometry.coordinates,i=this.map.project(t),u=Math.min(e.features.length,this.maxRatioUnitSize),d=this.computeAnchorOffset(u);e.position[0]=i.x+d[0],e.position[1]=i.y+d[1]}update(){if(!this.map)return null;let e=this.map.queryRenderedFeatures(void 0,{layers:this.layers});if(e=e.filter(r=>r.geometry.type==="Point"),typeof this.filter=="function"&&(e=e.filter(this.filter)),this.sortingProperty){if(typeof this.sortingProperty=="string"){const r=this.sortingProperty;e=e.filter(s=>s.properties[r]).sort((s,p)=>(s.properties[r]>p.properties[r]?1:-1)*this.sortingOrder)}else if(typeof this.sortingProperty=="function"){const r=this.sortingProperty;e=e.sort((s,p)=>(r(s)>r(p)?1:-1)*this.sortingOrder)}}const t=new Map;let i=[];if(this.groupBy)for(let r=0;r<e.length;r+=1){const s=e[r],p=this.groupBy==="coordinates"?P(s):s.properties[this.groupBy];let c;t.has(p)?c=t.get(p):(c={groupKey:p,features:[]},t.set(p,c),i.push(c)),c.features.length<this.maxNbFeaturesPerMarker&&c.features.push(s)}else i=e.map(r=>{var s;return{groupKey:(s=r.id)==null?void 0:s.toString(),features:[r]}});const u=new Map,d=new Map,g=new Map;let k=0;for(let r=0;r<i.length&&!(this.max&&k>=this.max);r+=1){const s=i[r],p=Math.min(s.features.length,this.maxRatioUnitSize),c=this.computeAnchorOffset(p),M=s.features[0],b=[this.markerSize[0],this.markerSize[1]*p],m=v(s.features),O=M.geometry.coordinates,S=this.map.project(O),f={id:m,position:[S.x+c[0],S.y+c[1]],size:b,internalElementSize:[this.markerSize[0],this.markerSize[1]],features:s.features};w(f,g)||(g.set(m,f),this.lastStatus.new.has(m)?(d.set(m,f),this.lastPresent.delete(m)):this.lastStatus.updated.has(m)?(d.set(m,f),this.lastPresent.delete(m)):u.set(m,f),k++)}return this.lastStatus.removed=this.lastPresent,this.lastPresent=g,this.lastStatus.new=u,this.lastStatus.updated=d,this.lastStatus}reset(){this.lastPresent.clear(),this.lastStatus.new.clear(),this.lastStatus.updated.clear(),this.lastStatus.removed.clear()}}a.MarkerLayout=z,Object.defineProperty(a,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=maptiler-marker-layout.umd.min.js.map
